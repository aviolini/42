version: '3.5'

services:
  server: &s
    build:
      context: ./
      dockerfile: Dockerfile
      target: server_target
    environment:
      - ROLE=server
    container_name: server
    image: server
    networks:
      irc-net:
        ipv4_address: 172.16.0.2
    volumes:
      - type: volume
        source: srcs_data
        target: /srcs
    stdin_open: true
    tty: true

  client1: &c
    <<: *s
    build:
      context: ./
      dockerfile: Dockerfile
      target: client_target
    image: client
    networks:
      - irc-net
    environment:
      - ROLE=client1
    container_name: client1
    depends_on:
      - server

  client2:
    <<: *c            #https://devops.stackexchange.com/questions/11318/docker-compose-multiple-services-in-a-loop
    environment:
      - ROLE=client2
    container_name: client2
    depends_on:
      - client1

  client3:
    <<: *c
    environment:
      - ROLE=client3
    container_name: client3
    depends_on:
      - client2

  client4:
    <<: *c
    environment:
      - ROLE=client4
    container_name: client4
    depends_on:
      - client3

networks:
  irc-net:
    name: lemp-net
    driver: bridge
    ipam:
     config:
       - subnet: 172.16.0.0/29  #6 ip liberi

volumes:
  srcs_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /SHARED/IRC
    name: srcs_data